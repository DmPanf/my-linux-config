#!/bin/bash

# 1. Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¸Ð· Ñ‚Ð¾Ð³Ð¾ Ð¶Ðµ Ñ„Ð°Ð¹Ð»Ð°, Ñ‡Ñ‚Ð¾ Ð¸ Ð±Ð¾Ñ‚
CONFIG="/etc/default/tg_bot.env"
if [ -f "$CONFIG" ]; then
    set -a
    source "$CONFIG"
    set +a
fi

# 2. ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ…
# Ð•ÑÐ»Ð¸ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³Ðµ Ð¿ÑƒÑÑ‚Ð¾, Ð±ÐµÑ€ÐµÐ¼ ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾Ðµ Ð¸Ð¼Ñ
FULL_HOST="${host:-$(hostname)}"

# ÐžÐ§Ð˜Ð¡Ð¢ÐšÐ Ð”Ð›Ð¯ FIGLET:
# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÑ‘ Ð¾Ñ‚ Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÑ‚Ñ€Ð¾ÐºÐ¸, Ð¿Ð¾ÐºÐ° Ð½Ðµ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð¼ Ð±ÑƒÐºÐ²Ñƒ, Ñ†Ð¸Ñ„Ñ€Ñƒ Ð¸Ð»Ð¸ ÑÐºÐ¾Ð±ÐºÑƒ [.
# Ð­Ñ‚Ð¾ Ð½Ð°Ð´ÐµÐ¶Ð½ÐµÐµ, Ñ‡ÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ 2 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð°, Ñ‚Ð°Ðº ÐºÐ°Ðº ÑÐ¼Ð¾Ð´Ð·Ð¸ Ð¼Ð¾Ð³ÑƒÑ‚ Ð·Ð°Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð½ÑƒÑŽ Ð´Ð»Ð¸Ð½Ñƒ.
CLEAN_HOST=$(echo "$FULL_HOST" | sed -E 's/^[^a-zA-Z0-9\[]+//')

# IP: Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ñƒ Ð¶Ðµ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ (Ð±ÐµÐ· Docker, Ð±ÐµÐ· IPv6)
IP=$(hostname -I | tr ' ' '\n' | grep -v ':' | grep -vE '^172\.(1[6-9]|2[0-9]|3[0-1])\.|^127\.' | paste -sd " " -)

# Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸
UPTIME=$(uptime -p | sed 's/up //')
# Load Average (Ð±ÐµÑ€ÐµÐ¼ 3 Ñ‡Ð¸ÑÐ»Ð°)
LOAD=$(cat /proc/loadavg | awk '{print $1, $2, $3}')
USERS=$(who | wc -l)
# Ð”Ð¸ÑÐº Ð¸ ÐŸÐ°Ð¼ÑÑ‚ÑŒ
DISK=$(df -h / --output=used,size | awk 'NR==2 {print $1 " / " $2}')
MEM=$(free -h | awk '/Mem:/ {print $3 " / " $2}')
DATE=$(date "+%d %b %Y %H:%M:%S")

# 3. Ð¦Ð²ÐµÑ‚Ð°
GREEN="\e[32m"
CYAN="\e[36m"
YELLOW="\e[33m"
RED="\e[31m"
RESET="\e[0m"

# 4. Ð’Ñ‹Ð²Ð¾Ð´ Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ð° (ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ð¾Ðµ Ð¸Ð¼Ñ)
echo -e "${YELLOW}"
figlet -t -f slant "$CLEAN_HOST"
echo -e "${RESET}"

# 5. Ð’Ñ‹Ð²Ð¾Ð´ Ð¸Ð½Ñ„Ð¾-Ð±Ð»Ð¾ÐºÐ°
echo -e "${CYAN}===================================================================${RESET}"
# Ð—Ð´ÐµÑÑŒ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ FULL_HOST (Ñ Ð¸ÐºÐ¾Ð½ÐºÐ¾Ð¹)
echo -e " ðŸ‘‹ Welcome to ${GREEN}$FULL_HOST${RESET}"
echo -e " ðŸŒ Server IP: ${GREEN}$IP${RESET}"
echo -e " â±  Uptime:    $UPTIME"
echo -e " ðŸ§  Load:      $LOAD"
echo -e " ðŸ‘¥ Users:     $USERS"
echo -e " ðŸ’¾ Disk /:    $DISK"
echo -e " ðŸ§® Memory:    $MEM"
echo -e " ðŸ“… Date:      $DATE"
echo -e "${CYAN}===================================================================${RESET}"

# 6. ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ (ÐµÑÐ»Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½)
if command -v cal > /dev/null; then
    cal -3
    echo -e "${CYAN}===================================================================${RESET}"
fi

# 7. Ð¤ÑƒÑ‚ÐµÑ€ (Ð’Ð°Ð¶Ð½Ð¾Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ)
echo -e "ðŸ”” INFO! Planned maintenance reboot: Monday/Thursday at 04:07am MSK."
echo -e "\n"
