#!/bin/bash

# 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
CONFIG="/etc/default/tg_bot.env"
if [ -f "$CONFIG" ]; then
    set -a
    source "$CONFIG"
    set +a
else
    exit 1
fi

# 2. –ê—Ä–≥—É–º–µ–Ω—Ç—ã
# –ü—Ä–∏–Ω–∏–º–∞–µ–º —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∫ –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç, –∏–ª–∏ —Å—Ç–∞–≤–∏–º –¥–µ—Ñ–æ–ª—Ç
TIME_TEXT="${1:-Scheduled}"
SRV_NAME="${host:-$(hostname)}"

# 3. –°–æ–æ–±—â–µ–Ω–∏–µ (–ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ)
# ‚è≥ - –ø–µ—Å–æ—á–Ω—ã–µ —á–∞—Å—ã, –ø–æ–∫–∞–∑—ã–≤–∞—é—â–∏–µ –æ–∂–∏–¥–∞–Ω–∏–µ
MSG="‚è≥ <b>$SRV_NAME</b>: Reboot initiated.
‚è∞ Target: <b>$TIME_TEXT</b>
üîª Server goes down in 3 minutes."

# 4. –û—Ç–ø—Ä–∞–≤–∫–∞
if [ -n "$TOKEN" ] && [ -n "$CHAT_ID1" ]; then
    /usr/bin/curl -s -m 5 -X POST "https://api.telegram.org/bot$TOKEN/sendMessage" \
    -d chat_id="$CHAT_ID1" \
    -d parse_mode="HTML" \
    -d text="$MSG" > /dev/null 2>&1
fi

# 5. –°–∞–º–∞ –∫–æ–º–∞–Ω–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ (+3 –º–∏–Ω—É—Ç—ã)
/sbin/shutdown -r +3 "Planned reboot at $TIME_TEXT"
